FROM node:20-alpine

# å®‰è£…å¿…è¦çš„å·¥å…·ï¼ˆcurl ç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN apk add --no-cache curl

# å®‰è£… claude-code-router
RUN npm install -g @musistudio/claude-code-router

# åˆ›å»ºé…ç½®ç›®å½•
RUN mkdir -p /root/.claude-code-router

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /root/.claude-code-router

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€šè¿‡ docker run æˆ– docker-compose è¦†ç›–ï¼‰
ENV HOST=0.0.0.0
ENV APIKEY=assdqweqwrwqrqwqweqwrwqrqwqweqwrwqrqw
ENV LOG=true
ENV LOG_LEVEL=debug
ENV NON_INTERACTIVE_MODE=true

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'set -e' >> /start.sh && \
    echo 'echo "ğŸš€ Starting Claude Code Router..."' >> /start.sh && \
    echo 'echo "ğŸ“ Generating config file..."' >> /start.sh && \
    echo 'cat > /root/.claude-code-router/config.json << EOF' >> /start.sh && \
    echo '{' >> /start.sh && \
    echo '  "HOST": "${HOST}",' >> /start.sh && \
    echo '  "APIKEY": "${APIKEY}",' >> /start.sh && \
    echo '  "LOG": ${LOG},' >> /start.sh && \
    echo '  "NON_INTERACTIVE_MODE": ${NON_INTERACTIVE_MODE},' >> /start.sh && \
    echo '  "Providers": [],' >> /start.sh && \
    echo '  "Router": {' >> /start.sh && \
    echo '    "default": ""' >> /start.sh && \
    echo '  }' >> /start.sh && \
    echo '}' >> /start.sh && \
    echo 'EOF' >> /start.sh && \
    echo 'echo "âœ… Config file generated at /root/.claude-code-router/config.json"' >> /start.sh && \
    echo 'echo "ğŸ”§ Config contents:"' >> /start.sh && \
    echo 'cat /root/.claude-code-router/config.json' >> /start.sh && \
    echo 'echo ""' >> /start.sh && \
    echo 'echo "ğŸŒ Server will listen on: ${HOST}:3456"' >> /start.sh && \
    echo 'echo "ğŸ” API Key: ${APIKEY:0:10}..."' >> /start.sh && \
    echo 'echo "ğŸ“Š Starting ccr..."' >> /start.sh && \
    echo 'echo ""' >> /start.sh && \
    echo 'exec ccr start' >> /start.sh && \
    chmod +x /start.sh

EXPOSE 3456

# æŒ‚è½½ç‚¹ç”¨äºæŒä¹…åŒ–é…ç½®å’Œæ—¥å¿—
VOLUME ["/root/.claude-code-router"]

CMD ["/start.sh"]
