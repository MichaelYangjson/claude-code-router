FROM node:20-alpine

# 安装 claude-code-router
RUN npm install -g @musistudio/claude-code-router

# 创建配置目录
RUN mkdir -p /root/.claude-code-router

# 设置工作目录
WORKDIR /root/.claude-code-router

# 设置环境变量（可通过 docker run 或 docker-compose 覆盖）
ENV HOST=0.0.0.0
ENV APIKEY=assdqweqwrwqrqwqweqwrwqrqwqweqwrwqrqw
ENV LOG=true
ENV NON_INTERACTIVE_MODE=true

# 创建启动脚本
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'cat > /root/.claude-code-router/config.json << EOF' >> /start.sh && \
    echo '{' >> /start.sh && \
    echo '  "HOST": "${HOST}",' >> /start.sh && \
    echo '  "APIKEY": "${APIKEY}",' >> /start.sh && \
    echo '  "LOG": ${LOG},' >> /start.sh && \
    echo '  "NON_INTERACTIVE_MODE": ${NON_INTERACTIVE_MODE},' >> /start.sh && \
    echo '  "Providers": [],' >> /start.sh && \
    echo '  "Router": {' >> /start.sh && \
    echo '    "default": ""' >> /start.sh && \
    echo '  }' >> /start.sh && \
    echo '}' >> /start.sh && \
    echo 'EOF' >> /start.sh && \
    echo 'exec ccr start' >> /start.sh && \
    chmod +x /start.sh

EXPOSE 3456

# 挂载点用于持久化配置和日志
VOLUME ["/root/.claude-code-router"]

CMD ["/start.sh"]
